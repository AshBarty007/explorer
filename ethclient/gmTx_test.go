package bs_eth

import (
	"context"
	"crypto/elliptic"
	"crypto/rand"
	"encoding/hex"
	"errors"
	"fmt"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/ethereum/go-ethereum/params"
	"github.com/ethereum/go-ethereum/rlp"
	"github.com/tjfoc/gmsm/sm2"
	"github.com/tjfoc/gmsm/sm3"
	"hash"
	"log"
	"math/big"
	"sync"
	"sync/atomic"
	"testing"
	"time"
)

var (
	p1  = "39725efee3fb28614de3bacaffe4cc4bd8c436257e2c8bb887c4b5c4be45e76d"
	p2  = "ffa912c02092899c1b359b144c6f38611d4d36e1a548bc07feaad9f6d42892bd"
	p3  = "9fd16a2008d879795506f46bb5e7c400ebf3108dc8c235318577b98894e15609"
	p4  = "f6299cb9ba7c7168a00286d341f381a312d46964ad961d67ebe5426767357c51"
	p5  = "9f843f6b690fcb7431c3b38b4ae0cc4e834757d5a122e44ea8240daef6fea720"
	a1  = "0x30E938B0630C02F394d17925FDB5fB046f70d452"
	a2  = "0x0CEe4290dD5aF09E089390B423bA876213a6a94F"
	a3  = "0x89C2D721eeBF8d27D1A89eCd336064a81BFaefcf"
	a4  = "0x45d1C3D293AB329921f9d2762B463644d43dB6FE"
	a5  = "0x1955DbE40cA8053D4A3d43fd71eCc8633cF73735"
	Url = "http://127.0.0.1:8545"
)

var bytecode = []byte("0x60a06040523480156200001157600080fd5b5060036080526200002162000027565b620000e9565b600054610100900460ff1615620000945760405162461bcd60e51b815260206004820152602760248201527f496e697469616c697a61626c653a20636f6e747261637420697320696e697469604482015266616c697a696e6760c81b606482015260840160405180910390fd5b60005460ff9081161015620000e7576000805460ff191660ff9081179091556040519081527f7f26b83ff96e1f2b6a682f133852f6798a09c465da95921460cefb38474024989060200160405180910390a15b565b60805161314c6200010c6000396000818161034101526112c8015261314c6000f3fe6080604052600436106101a55760003560e01c80635c975abb116100e1578063927ede2d1161008a578063b1a1a88211610064578063b1a1a88214610597578063c89701a2146105aa578063dad544e0146105d7578063e11013dd146105ec57600080fd5b8063927ede2d146105395780639a2ac6d514610564578063a9f9e6751461057757600080fd5b806387087623116100bb57806387087623146104d35780638f601f66146104f357806391c49bf81461048857600080fd5b80635c975abb146104635780637f46ddb214610488578063838b2520146104b357600080fd5b806338d38c971161014e578063485cc95511610128578063485cc955146103ad578063540abf73146103cd57806354fd4d50146103ed57806358a997f61461044357600080fd5b806338d38c971461032d5780633cb747bf1461036b5780633e47158c1461039857600080fd5b80631635f5fd1161017f5780631635f5fd146102ae57806333d7e2bd146102c157806335e80ab31461031857600080fd5b80630166a07a1461026857806309fc8843146102885780631532ec341461029b57600080fd5b36610263576101b26105ff565b610243576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603760248201527f5374616e646172644272696467653a2066756e6374696f6e2063616e206f6e6c60448201527f792062652063616c6c65642066726f6d20616e20454f4100000000000000000060648201526084015b60405180910390fd5b610261333362030d406040518060200160405280600081525061063c565b005b600080fd5b34801561027457600080fd5b50610261610283366004612b73565b61064f565b610261610296366004612c24565b610a69565b6102616102a9366004612c77565b610b45565b6102616102bc366004612c77565b610b59565b3480156102cd57600080fd5b506034546102ee9073ffffffffffffffffffffffffffffffffffffffff1681565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020015b60405180910390f35b34801561032457600080fd5b506102ee611022565b34801561033957600080fd5b5060405160ff7f000000000000000000000000000000000000000000000000000000000000000016815260200161030f565b34801561037757600080fd5b506003546102ee9073ffffffffffffffffffffffffffffffffffffffff1681565b3480156103a457600080fd5b506102ee6110bb565b3480156103b957600080fd5b506102616103c8366004612cea565b6112c6565b3480156103d957600080fd5b506102616103e8366004612d23565b61148c565b3480156103f957600080fd5b506104366040518060400160405280600581526020017f322e382e3000000000000000000000000000000000000000000000000000000081525081565b60405161030f9190612e10565b34801561044f57600080fd5b5061026161045e366004612e23565b6114d1565b34801561046f57600080fd5b506104786115aa565b604051901515815260200161030f565b34801561049457600080fd5b5060045473ffffffffffffffffffffffffffffffffffffffff166102ee565b3480156104bf57600080fd5b506102616104ce366004612d23565b61163e565b3480156104df57600080fd5b506102616104ee366004612e23565b611683565b3480156104ff57600080fd5b5061052b61050e366004612cea565b600260209081526000928352604080842090915290825290205481565b60405190815260200161030f565b34801561054557600080fd5b5060035473ffffffffffffffffffffffffffffffffffffffff166102ee565b610261610572366004612ea6565b61175c565b34801561058357600080fd5b50610261610592366004612b73565b61179e565b6102616105a5366004612c24565b6117ad565b3480156105b657600080fd5b506004546102ee9073ffffffffffffffffffffffffffffffffffffffff1681565b3480156105e357600080fd5b506102ee611883565b6102616105fa366004612ea6565b6118d7565b600032330361060e5750600190565b333b60170361063657604051602081016040526020600082333c5160e81c62ef010014905090565b50600090565b610649848434858561191a565b50505050565b60035473ffffffffffffffffffffffffffffffffffffffff1633148015610722575060048054600354604080517f6e296e45000000000000000000000000000000000000000000000000000000008152905173ffffffffffffffffffffffffffffffffffffffff938416949390921692636e296e459282820192602092908290030181865afa1580156106e6573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061070a9190612f09565b73ffffffffffffffffffffffffffffffffffffffff16145b6107d4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152604160248201527f5374616e646172644272696467653a2066756e6374696f6e2063616e206f6e6c60448201527f792062652063616c6c65642066726f6d20746865206f7468657220627269646760648201527f6500000000000000000000000000000000000000000000000000000000000000608482015260a40161023a565b6107dc6115aa565b15610843576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601660248201527f5374616e646172644272696467653a2070617573656400000000000000000000604482015260640161023a565b61084c87611ae4565b1561099a5761085b8787611b46565b61090d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152604a60248201527f5374616e646172644272696467653a2077726f6e672072656d6f746520746f6b60448201527f656e20666f72204f7074696d69736d204d696e7461626c65204552433230206c60648201527f6f63616c20746f6b656e00000000000000000000000000000000000000000000608482015260a40161023a565b6040517f40c10f1900000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff8581166004830152602482018590528816906340c10f1990604401600060405180830381600087803b15801561097d57600080fd5b505af1158015610991573d6000803e3d6000fd5b50505050610a1c565b73ffffffffffffffffffffffffffffffffffffffff8088166000908152600260209081526040808320938a16835292905220546109d8908490612f55565b73ffffffffffffffffffffffffffffffffffffffff8089166000818152600260209081526040808320948c1683529390529190912091909155610a1c908585611c66565b610a60878787878787878080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250611d3a92505050565b50505050505050565b610a716105ff565b610afd576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603760248201527f5374616e646172644272696467653a2066756e6374696f6e2063616e206f6e6c60448201527f792062652063616c6c65642066726f6d20616e20454f41000000000000000000606482015260840161023a565b610b403333348686868080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061191a92505050565b505050565b610b528585858585610b59565b5050505050565b60035473ffffffffffffffffffffffffffffffffffffffff1633148015610c2c575060048054600354604080517f6e296e45000000000000000000000000000000000000000000000000000000008152905173ffffffffffffffffffffffffffffffffffffffff938416949390921692636e296e459282820192602092908290030181865afa158015610bf0573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c149190612f09565b73ffffffffffffffffffffffffffffffffffffffff16145b610cde576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152604160248201527f5374616e646172644272696467653a2066756e6374696f6e2063616e206f6e6c60448201527f792062652063616c6c65642066726f6d20746865206f7468657220627269646760648201527f6500000000000000000000000000000000000000000000000000000000000000608482015260a40161023a565b610ce66115aa565b15610d4d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601660248201527f5374616e646172644272696467653a2070617573656400000000000000000000604482015260640161023a565b823414610ddc576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603a60248201527f5374616e646172644272696467653a20616d6f756e742073656e7420646f657360448201527f206e6f74206d6174636820616d6f756e74207265717569726564000000000000606482015260840161023a565b3073ffffffffffffffffffffffffffffffffffffffff851603610e81576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602360248201527f5374616e646172644272696467653a2063616e6e6f742073656e6420746f207360448201527f656c660000000000000000000000000000000000000000000000000000000000606482015260840161023a565b60035473ffffffffffffffffffffffffffffffffffffffff90811690851603610f2c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602860248201527f5374616e646172644272696467653a2063616e6e6f742073656e6420746f206d60448201527f657373656e676572000000000000000000000000000000000000000000000000606482015260840161023a565b610f6e85858585858080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250611dc892505050565b6000610f8b855a8660405180602001604052806000815250611e3b565b90508061101a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602360248201527f5374616e646172644272696467653a20455448207472616e736665722066616960448201527f6c65640000000000000000000000000000000000000000000000000000000000606482015260840161023a565b505050505050565b603454604080517f35e80ab3000000000000000000000000000000000000000000000000000000008152905160009273ffffffffffffffffffffffffffffffffffffffff16916335e80ab39160048083019260209291908290030181865afa158015611092573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906110b69190612f09565b905090565b6000806110e67fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035490565b905073ffffffffffffffffffffffffffffffffffffffff81161561110957919050565b6040518060400160405280601a81526020017f4f564d5f4c3143726f7373446f6d61696e4d657373656e67657200000000000081525051600261114c9190612f6c565b604080513060208201526000918101919091527f4f564d5f4c3143726f7373446f6d61696e4d657373656e67657200000000000091909117906111a7906060015b604051602081830303815290604052805190602001205490565b146111de576040517f54e433cd00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b604080513060208201526001918101919091526000906112009060600161118d565b905073ffffffffffffffffffffffffffffffffffffffff811615611294578073ffffffffffffffffffffffffffffffffffffffff16638da5cb5b6040518163ffffffff1660e01b8152600401602060405180830381865afa158015611269573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061128d9190612f09565b9250505090565b6040517f332144db00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b7f0000000000000000000000000000000000000000000000000000000000000000600054610100900460ff16158015611306575060005460ff8083169116105b611392576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201527f647920696e697469616c697a6564000000000000000000000000000000000000606482015260840161023a565b600080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00001660ff8316176101001790556113cb611e53565b603480547fffffffffffffffffffffffff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff841617905561142983734200000000000000000000000000000000000010611ed6565b600080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00ff16905560405160ff821681527f7f26b83ff96e1f2b6a682f133852f6798a09c465da95921460cefb38474024989060200160405180910390a1505050565b610a6087873388888888888080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250611fc092505050565b6114d96105ff565b611565576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603760248201527f5374616e646172644272696467653a2066756e6374696f6e2063616e206f6e6c60448201527f792062652063616c6c65642066726f6d20616e20454f41000000000000000000606482015260840161023a565b61101a86863333888888888080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061237992505050565b603454604080517f5c975abb000000000000000000000000000000000000000000000000000000008152905160009273ffffffffffffffffffffffffffffffffffffffff1691635c975abb9160048083019260209291908290030181865afa15801561161a573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906110b69190612fa9565b610a6087873388888888888080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061237992505050565b61168b6105ff565b611717576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603760248201527f5374616e646172644272696467653a2066756e6374696f6e2063616e206f6e6c60448201527f792062652063616c6c65642066726f6d20616e20454f41000000000000000000606482015260840161023a565b61101a86863333888888888080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250611fc092505050565b61064933858585858080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061063c92505050565b610a608787878787878761064f565b6117b56105ff565b611841576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603760248201527f5374616e646172644272696467653a2066756e6374696f6e2063616e206f6e6c60448201527f792062652063616c6c65642066726f6d20616e20454f41000000000000000000606482015260840161023a565b610b4033338585858080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061063c92505050565b600061188d6110bb565b73ffffffffffffffffffffffffffffffffffffffff16638da5cb5b6040518163ffffffff1660e01b8152600401602060405180830381865afa158015611092573d6000803e3d6000fd5b6106493385348686868080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061191a92505050565b8234146119a9576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603e60248201527f5374616e646172644272696467653a206272696467696e6720455448206d757360448201527f7420696e636c7564652073756666696369656e74204554482076616c75650000606482015260840161023a565b6119b585858584612388565b60035460045460405173ffffffffffffffffffffffffffffffffffffffff92831692633dbb202b9287929116907f1635f5fd0000000000000000000000000000000000000000000000000000000090611a18908b908b9086908a90602401612fcb565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529181526020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167fffffffff000000000000000000000000000000000000000000000000000000009485161790525160e086901b9092168252611aab92918890600401613014565b6000604051808303818588803b158015611ac457600080fd5b505af1158015611ad8573d6000803e3d6000fd5b50505050505050505050565b6000611b10827f1d1d8b63000000000000000000000000000000000000000000000000000000006123fb565b80611b405750611b40827fec4fc8e3000000000000000000000000000000000000000000000000000000006123fb565b92915050565b6000611b72837f1d1d8b63000000000000000000000000000000000000000000000000000000006123fb565b15611c1b578273ffffffffffffffffffffffffffffffffffffffff1663c01e1bd66040518163ffffffff1660e01b8152600401602060405180830381865afa158015611bc2573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611be69190612f09565b73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16149050611b40565b8273ffffffffffffffffffffffffffffffffffffffff1663d6c0b2c46040518163ffffffff1660e01b8152600401602060405180830381865afa158015611bc2573d6000803e3d6000fd5b60405173ffffffffffffffffffffffffffffffffffffffff8316602482015260448101829052610b409084907fa9059cbb00000000000000000000000000000000000000000000000000000000906064015b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529190526020810180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167fffffffff000000000000000000000000000000000000000000000000000000009093169290921790915261241e565b8373ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff167f3ceee06c1e37648fcbb6ed52e17b3e1f275a1f8c7b22a84b2b84732431e046b3868686604051611db293929190613059565b60405180910390a461101a86868686868661252a565b8273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f2ac69ee804d9a7a0984249f508dfab7cb2534b465b6ce1580f99a38ba9c5e6318484604051611e27929190613097565b60405180910390a3610649848484846125b2565b6000806000835160208501868989f195945050505050565b33611e5c6110bb565b73ffffffffffffffffffffffffffffffffffffffff1614158015611e9d575033611e84611883565b73ffffffffffffffffffffffffffffffffffffffff1614155b15611ed4576040517fc4050a2600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b565b600054610100900460ff16611f6d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602b60248201527f496e697469616c697a61626c653a20636f6e7472616374206973206e6f74206960448201527f6e697469616c697a696e67000000000000000000000000000000000000000000606482015260840161023a565b6003805473ffffffffffffffffffffffffffffffffffffffff9384167fffffffffffffffffffffffff00000000000000000000000000000000000000009182161790915560048054929093169116179055565b341561204e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602160248201527f5374616e646172644272696467653a2063616e6e6f742073656e642076616c7560448201527f6500000000000000000000000000000000000000000000000000000000000000606482015260840161023a565b61205787611ae4565b156121a5576120668787611b46565b612118576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152604a60248201527f5374616e646172644272696467653a2077726f6e672072656d6f746520746f6b60448201527f656e20666f72204f7074696d69736d204d696e7461626c65204552433230206c60648201527f6f63616c20746f6b656e00000000000000000000000000000000000000000000608482015260a40161023a565b6040517f9dc29fac00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff868116600483015260248201859052881690639dc29fac90604401600060405180830381600087803b15801561218857600080fd5b505af115801561219c573d6000803e3d6000fd5b50505050612239565b6121c773ffffffffffffffffffffffffffffffffffffffff881686308661261f565b73ffffffffffffffffffffffffffffffffffffffff8088166000908152600260209081526040808320938a16835292905220546122059084906130b0565b73ffffffffffffffffffffffffffffffffffffffff8089166000908152600260209081526040808320938b16835292905220555b61224787878787878661267d565b60035460045460405173ffffffffffffffffffffffffffffffffffffffff92831692633dbb202b9216907f0166a07a00000000000000000000000000000000000000000000000000000000906122ab908b908d908c908c908c908b906024016130c8565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529181526020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167fffffffff000000000000000000000000000000000000000000000000000000009485161790525160e085901b909216825261233e92918790600401613014565b600060405180830381600087803b15801561235857600080fd5b505af115801561236c573d6000803e3d6000fd5b5050505050505050505050565b610a6087878787878787611fc0565b8273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f35d79ab81f2b2017e19afb5c5571778877782d7a8786f5907f93b0f4702f4f2384846040516123e7929190613097565b60405180910390a36106498484848461270b565b60006124068361276a565b8015612417575061241783836127ce565b9392505050565b6000612480826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c65648152508573ffffffffffffffffffffffffffffffffffffffff1661289d9092919063ffffffff16565b805190915015610b40578080602001905181019061249e9190612fa9565b610b40576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e60448201527f6f74207375636365656400000000000000000000000000000000000000000000606482015260840161023a565b8373ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff167fd59c65b35445225835c83f50b6ede06a7be047d22e357073e250d9af537518cd8686866040516125a293929190613059565b60405180910390a4505050505050565b8273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f31b2166ff604fc5672ea5df08a78081d2bc6d746cadce880747f3643d819e83d8484604051612611929190613097565b60405180910390a350505050565b60405173ffffffffffffffffffffffffffffffffffffffff808516602483015283166044820152606481018290526106499085907f23b872dd0000000000000000000000000000000000000000000000000000000090608401611cb8565b8373ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff167f718594027abd4eaed59f95162563e0cc6d0e8d5b86b1c7be8b1b0ac3343d03968686866040516126f593929190613059565b60405180910390a461101a8686868686866128b4565b8273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f2849b43074093a05396b6f2a937dee8565b15a48a7b3d4bffb732a5017380af58484604051612611929190613097565b6000612796827f01ffc9a7000000000000000000000000000000000000000000000000000000006127ce565b8015611b4057506127c7827fffffffff000000000000000000000000000000000000000000000000000000006127ce565b1592915050565b604080517fffffffff000000000000000000000000000000000000000000000000000000008316602480830191909152825180830390910181526044909101909152602080820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167f01ffc9a700000000000000000000000000000000000000000000000000000000178152825160009392849283928392918391908a617530fa92503d91506000519050828015612886575060208210155b80156128925750600081115b979650505050505050565b60606128ac848460008561292c565b949350505050565b8373ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff167f7ff126db8024424bbfd9826e8ab82ff59136289ea440b04b39a0df1b03b9cabf8686866040516125a293929190613059565b6060824710156129be576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f60448201527f722063616c6c0000000000000000000000000000000000000000000000000000606482015260840161023a565b73ffffffffffffffffffffffffffffffffffffffff85163b612a3c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000604482015260640161023a565b6000808673ffffffffffffffffffffffffffffffffffffffff168587604051612a659190613123565b60006040518083038185875af1925050503d8060008114612aa2576040519150601f19603f3d011682016040523d82523d6000602084013e612aa7565b606091505b509150915061289282828660608315612ac1575081612417565b825115612ad15782518084602001fd5b816040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161023a9190612e10565b73ffffffffffffffffffffffffffffffffffffffff81168114612b2757600080fd5b50565b60008083601f840112612b3c57600080fd5b50813567ffffffffffffffff811115612b5457600080fd5b602083019150836020828501011115612b6c57600080fd5b9250929050565b600080600080600080600060c0888a031215612b8e57600080fd5b8735612b9981612b05565b96506020880135612ba981612b05565b95506040880135612bb981612b05565b94506060880135612bc981612b05565b93506080880135925060a088013567ffffffffffffffff811115612bec57600080fd5b612bf88a828b01612b2a565b989b979a50959850939692959293505050565b803563ffffffff81168114612c1f57600080fd5b919050565b600080600060408486031215612c3957600080fd5b612c4284612c0b565b9250602084013567ffffffffffffffff811115612c5e57600080fd5b612c6a86828701612b2a565b9497909650939450505050565b600080600080600060808688031215612c8f57600080fd5b8535612c9a81612b05565b94506020860135612caa81612b05565b935060408601359250606086013567ffffffffffffffff811115612ccd57600080fd5b612cd988828901612b2a565b969995985093965092949392505050565b60008060408385031215612cfd57600080fd5b8235612d0881612b05565b91506020830135612d1881612b05565b809150509250929050565b600080600080600080600060c0888a031215612d3e57600080fd5b8735612d4981612b05565b96506020880135612d5981612b05565b95506040880135612d6981612b05565b945060608801359350612d7e60808901612c0b565b925060a088013567ffffffffffffffff811115612bec57600080fd5b60005b83811015612db5578181015183820152602001612d9d565b838111156106495750506000910152565b60008151808452612dde816020860160208601612d9a565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169290920160200192915050565b6020815260006124176020830184612dc6565b60008060008060008060a08789031215612e3c57600080fd5b8635612e4781612b05565b95506020870135612e5781612b05565b945060408701359350612e6c60608801612c0b565b9250608087013567ffffffffffffffff811115612e8857600080fd5b612e9489828a01612b2a565b979a9699509497509295939492505050565b60008060008060608587031215612ebc57600080fd5b8435612ec781612b05565b9350612ed560208601612c0b565b9250604085013567ffffffffffffffff811115612ef157600080fd5b612efd87828801612b2a565b95989497509550505050565b600060208284031215612f1b57600080fd5b815161241781612b05565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600082821015612f6757612f67612f26565b500390565b6000817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615612fa457612fa4612f26565b500290565b600060208284031215612fbb57600080fd5b8151801515811461241757600080fd5b600073ffffffffffffffffffffffffffffffffffffffff80871683528086166020840152508360408301526080606083015261300a6080830184612dc6565b9695505050505050565b73ffffffffffffffffffffffffffffffffffffffff841681526060602082015260006130436060830185612dc6565b905063ffffffff83166040830152949350505050565b73ffffffffffffffffffffffffffffffffffffffff8416815282602082015260606040820152600061308e6060830184612dc6565b95945050505050565b8281526040602082015260006128ac6040830184612dc6565b600082198211156130c3576130c3612f26565b500190565b600073ffffffffffffffffffffffffffffffffffffffff80891683528088166020840152808716604084015280861660608401525083608083015260c060a083015261311760c0830184612dc6565b98975050505050505050565b60008251613135818460208701612d9a565b919091019291505056fea164736f6c634300080f000a")

/*
608060405234801561001057600080fd5b5060017fc670f864e1cbd31b04bbb7f207ac27ffee1b5925910425f98ee1448a774a05e960405160405180910390a27f1e69321bbdc0510e8b5f62e2a1bbbed6143ae12e782a1783a55e8fd5019f3b0f60405161006c90610175565b60405180910390a17fc0d505515bf144d2d18fa4d0308b7069fed35d610375ae95bca9cd33f25bde0a6040516100a1906101e1565b60405180910390a17f7c4352354ddbb23a20b7890913a0983763d5052c208f998378f159f5e6bd0e306040516100d69061024d565b60405180910390a17fec5dc4146de24512ee572c21b5a93986c75fdd0eea5c66655dca6e308a38550760405161010b906102b9565b60405180910390a16102d9565b600082825260208201905092915050565b7f68656c6c6f20776f726c64210000000000000000000000000000000000000000600082015250565b600061015f600c83610118565b915061016a82610129565b602082019050919050565b6000602082019050818103600083015261018e81610152565b9050919050565b7f7468697320697320612074657374210000000000000000000000000000000000600082015250565b60006101cb600f83610118565b91506101d682610195565b602082019050919050565b600060208201905081810360008301526101fa816101be565b9050919050565b7f676f6f64206c75636b20746f20796f7521000000000000000000000000000000600082015250565b6000610237601183610118565b915061024282610201565b602082019050919050565b600060208201905081810360008301526102668161022a565b9050919050565b7f6e69636520746f2073656520796f752100000000000000000000000000000000600082015250565b60006102a3601083610118565b91506102ae8261026d565b602082019050919050565b600060208201905081810360008301526102d281610296565b9050919050565b603f806102e76000396000f3fe6080604052600080fdfea26469706673582212209ba36049e149d523abc837bb02974b059268bbe9ab1e862fc137db2b4ee359c264736f6c634300081e0033
*/

func TestPriKey(t *testing.T) {
	testKey, _ := HexToSM2(p1)
	testAddr := PubkeyToAddress(testKey.PublicKey)
	pub := sm2.Compress(&testKey.PublicKey)

	fmt.Println(len(testAddr), testAddr)
	fmt.Println(len(pub), hex.EncodeToString(pub))

	byt := make([]byte, 100)
	copy(byt[:], pub)
	copy(byt[33:], testAddr.Bytes())

	fmt.Println(hex.EncodeToString(byt[:33]), hex.EncodeToString(byt[33:53]))
	fmt.Println(hex.EncodeToString(byt[:]))

	data := []byte("hello world")
	hash := sm3.Sm3Sum(data)
	sig, _ := testKey.Sign(rand.Reader, data, nil)
	fmt.Println("len(data),len(hash),len(sig),len(pub)", len(data), len(hash), len(sig), len(pub))

	toAddr := common.HexToAddress(a2)
	to := common.Address{}
	to.SetBytes(toAddr[:])
	fmt.Println("to", toAddr, to, &to)
}

func TestSendSm2Tx(t *testing.T) {
	client, err := Dial(Url)
	if err != nil {
		t.Fatal(err)
	}
	defer client.Close()

	testKey, _ := HexToSM2(p1)
	testAddr := PubkeyToAddress(testKey.PublicKey)
	fmt.Println("账户地址:", testAddr)

	nonce, err := client.NonceAt(context.Background(), testAddr, nil)
	if err != nil {
		t.Fatal(err)
	}

	//toAddr, _ := hex.DecodeString(a2)
	toAddr := common.HexToAddress(a4)
	to := common.Address{}
	to.SetBytes(toAddr[:])
	//fmt.Printf("发送交易 from: %x to: %x, value: %x \n", testAddr, to, big.NewInt(1).Mul(big.NewInt(1000000000), big.NewInt(1000000000)))

	gmTx := GmTx{
		ChainID: big.NewInt(1),
		Nonce:   nonce,
		//To:       &to,
		//Value:    big.NewInt(1).Mul(big.NewInt(1000000000), big.NewInt(1000000000)),
		Gas:      2200000,
		GasPrice: big.NewInt(params.InitialBaseFee),
		Data:     bytecode,
		//R, S      *big.Int,
		PublicKey: FromSM2Pub(&testKey.PublicKey),
	}
	h := Hash(gmTx)
	r, s, err := Sign(h[:], testKey)
	if err != nil {
		t.Fatal(err)
	}
	gmTx.R = r
	gmTx.S = s
	tx := GmTransaction{
		inner: gmTx,
		time:  time.Now(),
	}
	data, err := tx.MarshalBinary()
	if err != nil {
		t.Fatal(err)
	}

	encodeTx := hexutil.Encode(data)
	var txHash interface{}
	err = client.c.CallContext(context.Background(), &txHash, "eth_sendRawTransaction", encodeTx)
	if err != nil {
		t.Fatal(err)
	}
	fmt.Println("nonce", nonce)
	fmt.Println("签名哈希", h)
	fmt.Println("裸交易", encodeTx)
	fmt.Println("国密签名(r,s): ", r, s)
	fmt.Println("交易哈希: ", txHash)

	var result interface{}
	err = client.c.CallContext(context.Background(), &result, "eth_getTransactionByHash", txHash)
	fmt.Println("已上链，上链数据: ", result)
	fmt.Printf("交易后账户余额：")
	balanceOf(toAddr)
}

func balanceOf(addr common.Address) {
	client, err := ethclient.Dial(Url)
	if err != nil {
		log.Fatalf("Failed to connect to Ethereum client: %v", err)
	}
	defer client.Close()

	bal, _ := client.BalanceAt(context.Background(), addr, nil)
	fmt.Printf("address: %v balance: %v \n", addr, bal)
}

func HexToSM2(hexkey string) (*sm2.PrivateKey, error) {
	b, err := hex.DecodeString(hexkey)
	if byteErr, ok := err.(hex.InvalidByteError); ok {
		return nil, fmt.Errorf("invalid hex character %q in private key", byte(byteErr))
	} else if err != nil {
		return nil, errors.New("invalid hex data for private key")
	}
	return ToSM2(b)
}

func ToSM2(d []byte) (*sm2.PrivateKey, error) {
	return toSM2(d, true)
}

func toSM2(d []byte, strict bool) (*sm2.PrivateKey, error) {
	priv := new(sm2.PrivateKey)
	priv.PublicKey.Curve = sm2.P256Sm2()
	sm2p256v1N, _ := new(big.Int).SetString("FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123", 16)
	if strict && 8*len(d) != priv.Params().BitSize {
		return nil, fmt.Errorf("invalid length, need %d bits", priv.Params().BitSize)
	}
	priv.D = new(big.Int).SetBytes(d)

	// The priv.D must < N
	if priv.D.Cmp(sm2p256v1N) >= 0 {
		return nil, fmt.Errorf("invalid private key, >=N")
	}
	// The priv.D must not be zero or negative.
	if priv.D.Sign() <= 0 {
		return nil, fmt.Errorf("invalid private key, zero or negative")
	}

	priv.PublicKey.X, priv.PublicKey.Y = priv.PublicKey.Curve.ScalarBaseMult(d)
	if priv.PublicKey.X == nil {
		return nil, errors.New("invalid private key")
	}
	return priv, nil
}

type Sm3State interface {
	hash.Hash
	//Read([]byte) (int, error)
}

func NewSm3State() Sm3State {
	return sm3.New().(Sm3State)
}

func SM3(data ...[]byte) []byte {
	b := make([]byte, 32)
	d := NewSm3State()
	for _, b := range data {
		d.Write(b)
	}
	//d.Read(b)

	b = d.Sum(nil)
	return b
}

func FromSM2Pub(pub *sm2.PublicKey) []byte {
	if pub == nil || pub.X == nil || pub.Y == nil {
		return nil
	}
	return elliptic.Marshal(sm2.P256Sm2(), pub.X, pub.Y)
}

func PubkeyToAddress(p sm2.PublicKey) common.Address {
	pubBytes := FromSM2Pub(&p)
	return common.BytesToAddress(SM3(pubBytes[1:])[12:])
}

type GmTx struct {
	ChainID   *big.Int
	Nonce     uint64
	GasPrice  *big.Int
	Gas       uint64
	To        *common.Address `rlp:"nil"`
	Value     *big.Int
	Data      []byte
	R, S      *big.Int
	PublicKey []byte
}

func Hash(tx GmTx) common.Hash {
	return rlpHash([]interface{}{
		tx.Nonce,
		tx.GasPrice,
		tx.Gas,
		tx.To,
		tx.Value,
		tx.Data,
		tx.ChainID,
		uint(0),
		uint(0),
	})
}

var hasherPool = sync.Pool{
	New: func() interface{} { return sm3.New() },
}

//func rlpHash(x interface{}) (h common.Hash) {
//	sha := hasherPool.Get().(Sm3State)
//	defer hasherPool.Put(sha)
//	sha.Reset()
//	rlp.Encode(sha, x)
//	//sha.Read(h[:])
//	result := sha.Sum(nil)
//	h = common.BytesToHash(result)
//
//	var buf bytes.Buffer
//	rlp.Encode(&buf, x)
//	encoded := buf.Bytes()
//	eh := common.Bytes2Hex(encoded)
//	fmt.Println("未哈希交易:", eh, len(eh))
//
//	return h
//}

func zeroBytes(bytes []byte) {
	for i := range bytes {
		bytes[i] = 0
	}
}

const DigestLength int = 32

func Sign(digestHash []byte, prv *sm2.PrivateKey) (r, s *big.Int, err error) {
	if len(digestHash) != DigestLength {
		return big.NewInt(0), big.NewInt(0), fmt.Errorf("hash is required to be exactly %d bytes (%d)", DigestLength, len(digestHash))
	}

	return sm2.Sm2Sign(prv, digestHash, nil, rand.Reader)
	//return prv.Sign(rand.Reader, digestHash, nil)
}

type GmTransaction struct {
	inner GmTx      // Consensus contents of a transaction
	time  time.Time // Time first seen locally (spam avoidance)

	// caches
	hash atomic.Value
	size atomic.Value
	from atomic.Value
}

func (tx *GmTransaction) MarshalBinary() ([]byte, error) {
	return rlp.EncodeToBytes(tx.inner)
}

type EcdsaTx struct {
	ChainID  *big.Int
	Nonce    uint64
	GasPrice *big.Int
	Gas      uint64
	To       *common.Address `rlp:"nil"`
	Value    *big.Int
	Data     []byte
	R, S, V  *big.Int
}

func etxHash(tx EcdsaTx) common.Hash {
	return rlpHash([]interface{}{
		tx.Nonce,
		tx.GasPrice,
		tx.Gas,
		tx.To,
		tx.Value,
		tx.Data,
		tx.ChainID, uint(0), uint(0), uint(0),
	})
}

type EcdsaTransaction struct {
	inner EcdsaTx   // Consensus contents of a transaction
	time  time.Time // Time first seen locally (spam avoidance)

	// caches
	hash atomic.Value
	size atomic.Value
	from atomic.Value
}

func (tx *EcdsaTransaction) MarshalBinary() ([]byte, error) {
	return rlp.EncodeToBytes(tx.inner)
}

func UnCompressBytesToPub(e []byte) *sm2.PublicKey {
	key := &sm2.PublicKey{}
	key.X = new(big.Int).SetBytes(e[1:33])
	key.Y = new(big.Int).SetBytes(e[33:])
	key.Curve = sm2.P256Sm2()
	return key
}

func PubToUnCompressBytes(pub *sm2.PublicKey) []byte {
	xBytes := bigIntTo32Bytes(pub.X)
	yBytes := bigIntTo32Bytes(pub.Y)
	xl := len(xBytes)
	yl := len(yBytes)

	raw := make([]byte, 1+KeyBytes*2)
	raw[0] = UnCompress
	if xl > KeyBytes {
		copy(raw[1:1+KeyBytes], xBytes[xl-KeyBytes:])
	} else if xl < KeyBytes {
		copy(raw[1+(KeyBytes-xl):1+KeyBytes], xBytes)
	} else {
		copy(raw[1:1+KeyBytes], xBytes)
	}

	if yl > KeyBytes {
		copy(raw[1+KeyBytes:], yBytes[yl-KeyBytes:])
	} else if yl < KeyBytes {
		copy(raw[1+KeyBytes+(KeyBytes-yl):], yBytes)
	} else {
		copy(raw[1+KeyBytes:], yBytes)
	}
	return raw
}

const (
	BitSize    = 256
	KeyBytes   = (BitSize + 7) / 8
	UnCompress = 0x04
)

func bigIntTo32Bytes(bn *big.Int) []byte {
	byteArr := bn.Bytes()
	byteArrLen := len(byteArr)
	if byteArrLen == KeyBytes {
		return byteArr
	}
	byteArr = append(make([]byte, KeyBytes-byteArrLen), byteArr...)
	return byteArr
}

func TestSm2(t *testing.T) {
	hash := common.HexToHash("2daef60e7a0b8f5e024c81cd2ab3109f2b4f155cf83adeb2ae5532f74a157fdf")
	fmt.Println("hash", hash)

	pri, _ := HexToSM2("9fd16a2008d879795506f46bb5e7c400ebf3108dc8c235318577b98894e15609")
	pub := FromSM2Pub(&pri.PublicKey)
	R, S, _ := Sign(hash[:], pri)
	pb := UnCompressBytesToPub(pub)

	//R, _ := big.NewInt(0).SetString("f5aabd6d515dc7fb54d36172cd172769f15c73685f204f00c9ac88c14cf8f036", 16)
	//S, _ := big.NewInt(0).SetString("25be6382bd22e13bc231565f44418e0925a7a9f81370270fe62077fc7802f173", 16)
	r, s := R.Bytes(), S.Bytes()
	sig := make([]byte, 64)
	copy(sig[32-len(r):32], r)
	copy(sig[64-len(s):64], s)
	//sig := common.Hex2Bytes("304502206a446b4edc15089ec6eb5b06cf500c19bad961484aa6fb65575066e152fb6361022100ce7da6b250079c5bd3f2f5b640901647160220cad7c2964091c60814489251ae")
	//fmt.Println("sig", common.Bytes2Hex(sig))

	//pub := common.Hex2Bytes("043ce455fd10aff3f6ebf82a10270829b93b5e65aeebac604efcaba66e4c8a6091d59f747406d50b3bebf74cef1bc5bd1df28a0f181c9aa65ef612aa531ceec7c3")
	fmt.Println("pub", common.Bytes2Hex(pub))

	addr := PubkeyToAddress(pri.PublicKey)
	fmt.Println("addr:", addr)

	result := sm2.Sm2Verify(&pri.PublicKey, hash[:], []byte("1234567812345678"), R, S)
	fmt.Println(result)
	result = sm2.Sm2Verify(pb, hash[:], []byte("1234567812345678"), R, S)
	fmt.Println(result)
	result = pri.Verify(hash[:], sig)
	fmt.Println(result)
}

func TestGetAddress(t *testing.T) {
	var privateKeyHex = []string{
		"39725efee3fb28614de3bacaffe4cc4bd8c436257e2c8bb887c4b5c4be45e76d", //
		"9fd16a2008d879795506f46bb5e7c400ebf3108dc8c235318577b98894e15609",
		"ffa912c02092899c1b359b144c6f38611d4d36e1a548bc07feaad9f6d42892bd",
		"5d36dec0575f53fb8078a2b3a12d40386a5b4e81b682fb0ff2a836d2f7dba839",
		"b4b7fd9d0993346077dcc0903f0b27e4b26ca37b95a33b7b4f4129a2356ce976",
		"3ab2f3ab594a8006deeb895dff2ac89671b0219259f96a4f65e44221eac6c00c",
	} // 发送方私钥（无 0x 前缀）

	for _, v := range privateKeyHex {
		getAddress(v)
	}
}

func getAddress(privateKeyHex string) {
	// 1. 去掉可能存在的 "0x" 前缀
	if len(privateKeyHex) > 2 && privateKeyHex[:2] == "0x" {
		privateKeyHex = privateKeyHex[2:]
	}

	// 2. 将 hex 字符串解码为 []byte
	privateKeyBytes, err := hexutil.Decode("0x" + privateKeyHex)
	if err != nil {
		log.Fatalf("Failed to decode private key: %v", err)
	}

	// 3. 从字节恢复私钥对象
	privateKey, err := ToSM2(privateKeyBytes)
	if err != nil {
		log.Fatalf("Failed to parse private key: %v", err)
	}

	// 4. 从私钥生成公钥
	publicKey := privateKey.PublicKey
	// 5. 从公钥计算地址
	address := PubkeyToAddress(publicKey)

	// 6. 输出结果
	fmt.Printf("Private Key (hex): 0x%s\n", privateKeyHex)
	fmt.Printf("Address: %s\n", address.Hex())
}
